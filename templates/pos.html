{% extends "base.html" %}
{% block title %}Punto de Venta{% endblock %}
{% block styles %}
<style>
    .main-content { display: flex; flex-direction: column; height: calc(100vh - 120px); }
    #search-results { list-style-type: none; padding: 0; margin: 0; border: 1px solid var(--border-color); display: none; max-height: 200px; overflow-y: auto; background-color: var(--surface-color); position: absolute; z-index: 1000; width: 100%;}
    #search-results li:hover { background-color: var(--primary-blue); color: #fff; }
    .pos-main-grid { display: grid; grid-template-columns: 3fr 5fr; gap: 1.5rem; flex-grow: 1; }
    @media (max-width: 992px) { .pos-main-grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}
{% block content %}
<form id="sale-form" action="{{ url_for('procesar_venta') }}" method="POST">
    <div class="pos-main-grid">
        <div class="card">
            <div class="card-header"><h5 class="mb-0">1. Buscar y Añadir</h5></div>
            <div class="card-body">
                <label for="product-search" class="form-label fw-bold">Buscar Producto:</label>
                <div class="position-relative">
                    <input type="text" id="product-search" class="form-control" placeholder="Escribe para buscar...">
                    <ul id="search-results" class="mt-1 rounded shadow-lg"></ul>
                </div>
                <hr class="my-4">
                <h5 class="mb-3">2. Datos del Cliente (Opcional)</h5>
                <div class="mb-3"><label for="cliente_nombre" class="form-label">Nombre:</label><input type="text" id="cliente_nombre" name="cliente_nombre" class="form-control"></div>
                <div class="mb-3"><label for="cliente_telefono" class="form-label">Teléfono:</label><input type="tel" id="cliente_telefono" name="cliente_telefono" class="form-control"></div>
            </div>
        </div>
        <div class="card d-flex flex-column">
            <div class="card-header"><h5 class="mb-0">3. Carrito de Venta</h5></div>
            <div class="card-body p-0 d-flex flex-column" style="flex-grow: 1;">
                <div class="table-responsive" style="flex-grow: 1;">
                    <table class="table table-sm align-middle mb-0">
                        <thead><tr><th>Producto</th><th>Precio</th><th style="width: 130px;" class="text-center">Cantidad</th><th class="text-end">Subtotal</th><th></th></tr></thead>
                        <tbody id="cart-table-body"><tr><td colspan="5" class="text-center text-muted pt-5">El carrito está vacío</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <input type="hidden" name="cart_data" id="cart-data-input">
                <div class="d-flex justify-content-end align-items-center">
                    <h3 class="me-4 mb-0">Total: <span id="cart-total" class="text-primary fw-bold">$0.00</span></h3>
                    <button id="finalize-sale-btn" type="submit" class="btn btn-primary btn-lg" disabled><i class="bi bi-check-lg me-2"></i>Finalizar Venta</button>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}
{% block scripts %}
<script>
    let cart={};const searchInput=document.getElementById("product-search"),searchResults=document.getElementById("search-results"),cartBody=document.getElementById("cart-table-body"),cartTotalSpan=document.getElementById("cart-total"),finalizeBtn=document.getElementById("finalize-sale-btn"),saleForm=document.getElementById("sale-form"),cartDataInput=document.getElementById("cart-data-input");let debounceTimer;searchInput.addEventListener("input",()=>{clearTimeout(debounceTimer),debounceTimer=setTimeout(()=>{const e=searchInput.value;e.length<2?(searchResults.style.display="none",void 0):fetch(`/api/buscar_productos?q=${e}`).then(e=>e.json()).then(e=>displaySearchResults(e))},300)}),function displaySearchResults(e){searchResults.innerHTML="",e.length>0?(e.forEach(e=>{const t=document.createElement("li");t.innerHTML=`${e.nombre} <small class="text-muted">(Stock: ${e.cantidad})</small>`,t.dataset.productId=e.id,t.dataset.productName=e.nombre,t.dataset.productPrice=e.precio,t.dataset.productStock=e.cantidad,t.classList.add("list-group-item","list-group-item-action","border-0","px-3","py-2"),searchResults.appendChild(t)}),searchResults.style.display="block"):searchResults.style.display="none"}searchResults.addEventListener("click",e=>{if("LI"===e.target.tagName){const t=e.target.dataset;parseInt(t.productStock)>0?addToCart(t):alert("Este producto no tiene stock disponible."),searchInput.value="",searchResults.style.display="none"}}),function addToCart(e){const t=e.productId;cart[t]?cart[t].quantity<parseInt(e.productStock)&&cart[t].quantity++:cart[t]={name:e.productName,price:parseFloat(e.productPrice),quantity:1,stock:parseInt(e.productStock)},renderCart()}function renderCart(){if(cartBody.innerHTML="",0===Object.keys(cart).length)return cartBody.innerHTML='<tr><td colspan="5" class="text-center text-muted p-5">El carrito está vacío</td></tr>',cartTotalSpan.textContent="$0.00",void(finalizeBtn.disabled=!0);let e=0;for(const t in cart){const o=cart[t],a=o.quantity*o.price;e+=a;const n=document.createElement("tr");n.innerHTML=`<td>${o.name}</td><td>$${o.price.toFixed(2)}</td><td class="text-center"><div class="input-group input-group-sm"><button type="button" class="btn btn-outline-secondary cart-qty-btn" data-id="${t}" data-action="decrement">-</button><input type="text" class="form-control text-center" value="${o.quantity}" readonly><button type="button" class="btn btn-outline-secondary cart-qty-btn" data-id="${t}" data-action="increment">+</button></div></td><td class="text-end">$${a.toFixed(2)}</td><td><button type="button" class="btn btn-danger btn-sm cart-remove-btn" data-id="${t}"><i class="bi bi-x-lg"></i></button></td>`,cartBody.appendChild(n)}cartTotalSpan.textContent=`$${e.toFixed(2)}`,finalizeBtn.disabled=0===Object.keys(cart).length}cartBody.addEventListener("click",e=>{const t=e.target.closest("button"),o=t?.dataset.id;o&&(t.classList.contains("cart-qty-btn")?("increment"===t.dataset.action&&cart[o].quantity<cart[o].stock?cart[o].quantity++:"decrement"===t.dataset.action&&cart[o].quantity>1&&cart[o].quantity--):t.classList.contains("cart-remove-btn")&&delete cart[o],renderCart())}),saleForm.addEventListener("submit",function(e){return 0===Object.keys(cart).length?(e.preventDefault(),void alert("El carrito está vacío.")):void(cartDataInput.value=JSON.stringify(cart))});
</script>
{% endblock %}