<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Inventario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .table .table-danger, .table .table-danger > th, .table .table-danger > td { background-color: #f8d7da !important; color: #721c24 !important; }
        .stock-control { display: flex; align-items: center; justify-content: space-between; min-width: 90px; }
        .stock-control .btn { padding: .1rem .4rem; font-size: .8rem; }
        .user-nav a.btn { margin-left: 0.5rem; }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4">
        {% if session.user_id %}
        <div class="d-flex justify-content-between align-items-center bg-white p-3 mb-4 rounded shadow-sm">
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle"></i> Bienvenido, <strong>{{ session.username }}</strong>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{{ url_for('cambiar_password') }}">Cambiar Contraseña</a></li>
                    {% if session.rol == 'admin' %}
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('editar_empresa') }}">Perfil de la Empresa</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('gestionar_usuarios') }}">Administrar Usuarios</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('ver_historial') }}">Historial de Actividad</a></li>
                    {% endif %}
                </ul>
            </div>
            <div class="user-nav">
                <a href="{{ url_for('pos') }}" class="btn btn-success">Punto de Venta</a>
                <a href="{{ url_for('reportes') }}" class="btn btn-info">Reportes</a>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary">Cerrar Sesión</a>
            </div>
        </div>
        {% endif %}
        
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}{% for category, message in messages %}<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>{% endfor %}{% endif %}
        {% endwith %}
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="mb-0">Inventario</h1>
            {% if session.rol == 'admin' %}<a href="{{ url_for('agregar_producto') }}" class="btn btn-primary">Añadir Nuevo Producto</a>{% endif %}
        </div>
        
        <div class="row mb-4">
            <div class="col-md-4 mb-3"><div class="card text-center h-100"><div class="card-header">Productos Únicos</div><div class="card-body d-flex align-items-center justify-content-center"><h5 class="card-title mb-0">{{ total_productos }}</h5></div></div></div>
            <div class="col-md-4 mb-3"><div class="card text-center h-100"><div class="card-header">Total de Artículos en Stock</div><div class="card-body d-flex align-items-center justify-content-center"><h5 class="card-title mb-0">{{ total_stock }}</h5></div></div></div>
            <div class="col-md-4 mb-3"><div class="card text-center h-100"><div class="card-header">Valor Total del Inventario</div><div class="card-body d-flex align-items-center justify-content-center"><h5 class="card-title mb-0">${{ "%.2f"|format(valor_inventario) }}</h5></div></div></div>
        </div>
        
        <form method="GET" action="{{ url_for('mostrar_inventario') }}" class="mb-4"><div class="input-group"><input type="text" name="q" class="form-control" placeholder="Buscar por nombre o marca..." value="{{ query or '' }}"><button class="btn btn-outline-secondary" type="submit">Buscar</button></div></form>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered align-middle">
                <thead class="table-dark"><tr><th>#</th><th>Nombre</th><th>Marca</th><th>Modelo</th><th>Precio</th><th>Stock</th>{% if session.rol == 'admin' %}<th>Acciones</th>{% endif %}</tr></thead>
                <tbody id="inventory-table-body">
                    {% for producto in inventario %}
                    <tr class="{{ 'table-danger' if producto.cantidad < 5 else '' }}">
                        <td>{{ (page - 1) * PER_PAGE + loop.index }}</td><td>{{ producto.nombre }}</td><td>{{ producto.marca }}</td><td>{{ producto.modelo }}</td><td>${{ "%.2f"|format(producto.precio) }}</td>
                        <td><div class="stock-control"><button class="btn btn-outline-secondary stock-btn" data-id="{{ producto.id }}" data-action="decrementar">-</button><span id="stock-{{ producto.id }}" class="mx-2 fw-bold">{{ producto.cantidad }}</span><button class="btn btn-outline-secondary stock-btn" data-id="{{ producto.id }}" data-action="incrementar">+</button></div></td>
                        {% if session.rol == 'admin' %}<td><a href="{{ url_for('editar_producto', producto_id=producto.id) }}" class="btn btn-warning btn-sm">Editar</a><a href="{{ url_for('eliminar_producto', producto_id=producto.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('¿Estás seguro?');">Eliminar</a></td>{% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <nav class="mt-4"><ul class="pagination justify-content-center"><li class="page-item {{ 'disabled' if page <= 1 else '' }}"><a class="page-link" href="{{ url_for('mostrar_inventario', page=page-1, q=query) }}">Anterior</a></li><li class="page-item active" aria-current="page"><span class="page-link">Página {{ page }} de {{ total_pages }}</span></li><li class="page-item {{ 'disabled' if page >= total_pages else '' }}"><a class="page-link" href="{{ url_for('mostrar_inventario', page=page+1, q=query) }}">Siguiente</a></li></ul></nav>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('inventory-table-body')?.addEventListener('click',function(e){const t=e.target;if(t.classList.contains('stock-btn')){const e=t.dataset.id,o=t.dataset.action;fetch(`/api/actualizar_stock/${e}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:o})}).then(e=>e.json()).then(o=>{if(o.success){const n=document.getElementById(`stock-${e}`);n.textContent=o.nueva_cantidad;const c=t.closest('tr');o.nueva_cantidad<5?c.classList.add('table-danger'):c.classList.remove('table-danger')}else console.error('Error al actualizar el stock:',o.message)}).catch(e=>console.error('Error de red:',e))}});
    </script>
</body>
</html>